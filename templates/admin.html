<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard | Hospital Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f7f9fc;
            font-family: 'Poppins', sans-serif;
        }
        .sidebar {
            background-color: #98fb98;
            color: #333;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
        }
        .sidebar a {
            color: #333;
            text-decoration: none;
            display: block;
            padding: 10px 20px;
            cursor: pointer;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #81d481;
            font-weight: bold;
        }
        .sidebar .logout-link {
            margin-top: auto;
            margin-bottom: 20px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stat-card {
            text-align: center;
            padding: 20px;
            color: #fff;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }

        /* CHATBOT CSS (Kh√¥ng ƒë·ªïi) */
        #chatbot-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: #4CAF50;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
            z-index: 9999;
        }

        #chatbot-box {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 350px;
            height: 450px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 9999;
        }

        #chat-header {
            background: #4CAF50;
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 18px;
        }

        #chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        
        /* Bong b√≥ng chat Admin */
        .msg-user {
            background: #DCF8C6; 
            color: #333;
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            width: fit-content;
            max-width: 80%;
            margin-left: auto;
        }

        .msg-bot {
            background: #eee; 
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            width: fit-content;
            max-width: 80%;
        }

        #chat-input-box {
            display: flex;
            border-top: 1px solid #ddd;
        }

        #chat-input {
            flex: 1;
            border: none;
            padding: 10px;
            outline: none;
        }

        #send-btn-chat {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4 class="text-center">üè• Qu·∫£n L√Ω B·ªánh Vi·ªán</h4>
        <hr>
        <a onclick="showSection('dashboard')" class="active">Dashboard</a>
        <a onclick="showSection('patients')">Danh S√°ch B·ªánh Nh√¢n</a>
        <a onclick="showSection('appointments')">L·ªãch Kh√°m</a>
        <a onclick="showSection('medicines')">Kho Thu·ªëc</a>
        <a onclick="showSection('orders')">ƒê∆°n H√†ng</a>
        <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h3 class="text-primary mb-4">Admin Dashboard</h3>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- DASHBOARD (Section 1) -->
        <div id="dashboard" class="content-section">
            <h4>Th·ªëng K√™ T·ªïng Quan</h4>
            <div class="row">
                <div class="col-md-4"><div class="stat-card bg-primary"><div class="stat-number">{{ stats.total_patients }}</div><div>T·ªïng B·ªánh Nh√¢n</div></div></div>
                <div class="col-md-4"><div class="stat-card bg-warning"><div class="stat-number">{{ stats.pending_appt }}</div><div>L·ªãch Kh√°m ƒêang Ch·ªù</div></div></div>
                <div class="col-md-4"><div class="stat-card" style="background-color: #f7a049;"><div class="stat-number">{{ stats.pending_order }}</div><div>ƒê∆°n H√†ng ƒêang Ch·ªù</div></div></div>
            </div>
            <div class="row">
                <div class="col-md-4"><div class="stat-card bg-success"><div class="stat-number">{{ stats.approved_appt }}</div><div>L·ªãch Kh√°m ƒê√£ Ch·∫•p Thu·∫≠n</div></div></div>
                <div class="col-md-4"><div class="stat-card bg-danger"><div class="stat-number">{{ stats.rejected_appt }}</div><div>L·ªãch Kh√°m ƒê√£ T·ª´ Ch·ªëi</div></div></div>
                <div class="col-md-4"><div class="stat-card" style="background-color: #3b9c40;"><div class="stat-number">{{ stats.processed_order }}</div><div>ƒê∆°n H√†ng ƒê√£ X·ª≠ L√Ω</div></div></div>
            </div>
        </div>

        <!-- PATIENT LIST (Section 2) -->
        <div id="patients" class="card p-3 mb-4 content-section" style="display: none;">
            <h5>Danh S√°ch B·ªánh Nh√¢n ƒê√£ ƒêƒÉng K√Ω</h5>
            <input id="patient-search" class="form-control mb-2" placeholder="T√¨m ki·∫øm b·ªánh nh√¢n...">
            <table class="table table-bordered" id="patient-table">
                <thead><tr><th>T√™n</th><th>Tu·ªïi</th><th>Email</th></tr></thead>
                <tbody>
                {% for p in patients %}
                  <tr><td>{{ p[0] }}</td><td>{{ p[1] }}</td><td>{{ p[2] }}</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- APPOINTMENTS (Section 3) -->
        <div id="appointments" class="card p-3 mb-4 content-section" style="display: none;">
            <h5>Danh S√°ch L·ªãch Kh√°m</h5>
            <input id="appointment-search" class="form-control mb-2" placeholder="T√¨m ki·∫øm l·ªãch kh√°m...">
            <table class="table table-bordered align-middle" id="appointment-table">
                <thead>
                  <tr><th>B·ªánh nh√¢n</th><th>Email</th><th>B·ªánh</th><th>Ng√†y/Gi·ªù</th><th>Tr·∫°ng th√°i</th><th>·∫¢nh</th><th>H√†nh ƒë·ªông</th></tr>
                </thead>
                <tbody>
                {% for a in appointments %}
                  <tr>
                    <td>{{ a[1] }}</td>
                    <td>{{ a[2] }}</td>
                    <td>{{ a[3] }}</td>
                    <td>{{ a[4] }}</td>
                    <td>
                      {% if a[5]=='approved' %}<span class="badge bg-success">Ch·∫•p nh·∫≠n</span>
                      {% elif a[5]=='rejected' %}<span class="badge bg-danger">T·ª´ ch·ªëi</span>
                      {% else %}<span class="badge bg-secondary">ƒêang ch·ªù</span>{% endif %}
                    </td>
                    <td>
                      {% if a[6] %}
                        <a href="{{ url_for('uploaded_file', filename=a[6]) }}" target="_blank">
                          <img src="{{ url_for('uploaded_file', filename=a[6]) }}" style="max-width:100px;">
                        </a>
                      {% else %}Kh√¥ng c√≥{% endif %}
                    </td>
                    <td>
                      {% if a[5]=='pending' %}
                        <form action="{{ url_for('update_status', type='appt', item_id=a[0], status='approved') }}" method="POST" style="display:inline;">
                          <button class="btn btn-sm btn-success">Ch·∫•p nh·∫≠n</button>
                        </form>
                        <form action="{{ url_for('update_status', type='appt', item_id=a[0], status='rejected') }}" method="POST" style="display:inline;">
                          <button class="btn btn-sm btn-danger">T·ª´ ch·ªëi</button>
                        </form>
                      {% else %}
                        <span class="fw-bold">{{ a[5] }}</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- MEDICINES (Section 4) -->
        <div id="medicines" class="card p-3 mb-4 content-section" style="display: none;">
            <h5>Qu·∫£n L√Ω Kho Thu·ªëc</h5>
            
            <!-- Form Th√™m/S·ª≠a Thu·ªëc -->
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#medicineModal">Th√™m Thu·ªëc M·ªõi</button>

            <table class="table table-bordered align-middle">
                <thead>
                    <tr><th>ID</th><th>T√™n Thu·ªëc</th><th>M√¥ t·∫£</th><th>Gi√° (VNƒê)</th><th>T·ªìn kho</th><th>H√†nh ƒë·ªông</th></tr>
                </thead>
                <tbody>
                    {% for m in medicines %}
                    <tr>
                        <td>{{ m[0] }}</td>
                        <td>{{ m[1] }}</td>
                        <td>{{ m[4] }}</td>
                        <td>{{ "{:,.0f}".format(m[2]) }}</td>
                        <td><span class="badge bg-{{ 'danger' if m[3] < 10 else 'success' }}">{{ m[3] }}</span></td>
                        <td>
                            <!-- ƒê√É S·ª¨A L·ªñI TRI·ªÜT ƒê·ªÇ: D√πng data attributes thay v√¨ truy·ªÅn tr·ª±c ti·∫øp tham s·ªë ph·ª©c t·∫°p -->
                            <button class="btn btn-sm btn-warning edit-medicine-btn" 
                                data-id="{{ m[0] }}" 
                                data-name="{{ m[1] }}" 
                                data-description="{{ m[4] }}" 
                                data-price="{{ m[2] }}" 
                                data-stock="{{ m[3] }}">
                                S·ª≠a
                            </button>
                            <form action="{{ url_for('delete_medicine', med_id=m[0]) }}" method="POST" style="display:inline;" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a thu·ªëc {{ m[1] }}?');">
                                <button class="btn btn-sm btn-danger">X√≥a</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- ORDERS (Section 5) -->
        <div id="orders" class="card p-3 mb-4 content-section" style="display: none;">
            <h5>Danh S√°ch ƒê∆°n H√†ng</h5>
            <!-- ƒê√É TH√äM: Input t√¨m ki·∫øm cho ƒê∆°n h√†ng -->
            <input id="order-search" class="form-control mb-2" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng..."> 
            <table class="table table-bordered align-middle" id="order-table">
                <thead>
                    <tr><th>ID</th><th>Kh√°ch h√†ng</th><th>T√™n Thu·ªëc</th><th>SL</th><th>T·ªïng ti·ªÅn</th><th>Ng√†y ƒë·∫∑t</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr>
                </thead>
                <tbody>
                    {% for o in orders %}
                    <tr>
                        <td>#{{ o[0] }}</td>
                        <td>{{ o[1] }}</td>
                        <td>{{ o[2] }}</td>
                        <td>{{ o[3] }}</td>
                        <td>{{ "{:,.0f}".format(o[4]) }} VNƒê</td>
                        <td>{{ o[5].split(' ')[0] }}</td>
                        <td>
                            {% if o[6]=='processed' %}<span class="badge bg-success">ƒê√£ x·ª≠ l√Ω</span>
                            {% elif o[6]=='cancelled' %}<span class="badge bg-danger">ƒê√£ h·ªßy</span>
                            {% else %}<span class="badge bg-warning">ƒêang ch·ªù</span>{% endif %}
                        </td>
                        <td>
                            {% if o[6]=='pending' %}
                                <form action="{{ url_for('update_status', type='order', item_id=o[0], status='processed') }}" method="POST" style="display:inline;">
                                    <button class="btn btn-sm btn-success">X·ª≠ l√Ω</button>
                                </form>
                                <form action="{{ url_for('update_status', type='order', item_id=o[0], status='cancelled') }}" method="POST" style="display:inline;">
                                    <button class="btn btn-sm btn-danger">H·ªßy</button>
                                </form>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
    
    <!-- MODAL TH√äM/S·ª¨A THU·ªêC -->
    <div class="modal fade" id="medicineModal" tabindex="-1" aria-labelledby="medicineModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST" action="{{ url_for('manage_medicine') }}" id="medicine-form">
            <input type="hidden" name="id" id="med-id">
            <div class="modal-header">
              <h5 class="modal-title" id="medicineModalLabel">Th√™m/S·ª≠a Thu·ªëc</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3"><label>T√™n Thu·ªëc</label><input type="text" name="name" id="med-name" class="form-control" required></div>
                <div class="mb-3"><label>M√¥ t·∫£</label><textarea name="description" id="med-description" class="form-control" rows="2"></textarea></div>
                <div class="mb-3"><label>Gi√° (VNƒê)</label><input type="number" name="price" id="med-price" class="form-control" min="1000" required></div>
                <div class="mb-3"><label>T·ªìn kho</label><input type="number" name="stock" id="med-stock" class="form-control" min="0" required></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
              <button type="submit" class="btn btn-primary">L∆∞u Thay ƒê·ªïi</button>
            </div>
          </form>
        </div>
      </div>
    </div>


    <!-- CHATBOT BUTTON -->
    <button id="chatbot-btn">üí¨</button>

    <!-- CHATBOT BOX -->
    <div id="chatbot-box">
        <div id="chat-header">ü§ñ ChatBot - H·ªó tr·ª£ Admin</div>
        <div id="chat-messages"></div>

        <div id="chat-input-box">
            <input id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
            <button id="send-btn">G·ª≠i</button>
        </div>
    </div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // === LOGIC ƒêI·ªÄU H∆Ø·ªöNG SIDEBAR ===
    function showSection(sectionId) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(sectionId).style.display = 'block';

        document.querySelectorAll('.sidebar a').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`.sidebar a[onclick="showSection('${sectionId}')"]`).classList.add('active');
    }

    // Kh·ªüi t·∫°o hi·ªÉn th·ªã Dashboard khi t·∫£i trang
    document.addEventListener('DOMContentLoaded', () => {
        showSection('dashboard');
        // Kh·ªüi t·∫°o tin nh·∫Øn ch√†o m·ª´ng chatbot admin
        addMessage("Ch√†o Admin! T√¥i l√† tr·ª£ l√Ω AI. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m ki·∫øm th√¥ng tin v·ªÅ l·ªãch h·∫πn ho·∫∑c ƒë∆°n h√†ng.", "bot");
        
        // G√°n s·ª± ki·ªán click cho c√°c n√∫t "S·ª≠a" sau khi DOM t·∫£i xong
        document.querySelectorAll('.edit-medicine-btn').forEach(button => {
            button.addEventListener('click', function() {
                // L·∫•y d·ªØ li·ªáu t·ª´ data attributes
                const id = this.dataset.id;
                const name = this.dataset.name;
                const description = this.dataset.description;
                const price = this.dataset.price;
                const stock = this.dataset.stock;
                
                editMedicine(id, name, description, price, stock);
            });
        });
    });
    
    // === LOGIC QU·∫¢N L√ù THU·ªêC (MODAL) - ƒê√É C·∫¨P NH·∫¨T ƒë·ªÉ nh·∫≠n tham s·ªë tr·ª±c ti·∫øp ===
    function editMedicine(id, name, description, price, stock) {
        document.getElementById('medicineModalLabel').innerText = 'S·ª≠a Th√¥ng Tin Thu·ªëc';
        document.getElementById('med-id').value = id;
        // C√°c gi√° tr·ªã chu·ªói kh√¥ng c·∫ßn replace() n·ªØa v√¨ ƒë√£ d√πng data attributes an to√†n
        document.getElementById('med-name').value = name; 
        document.getElementById('med-description').value = description;
        document.getElementById('med-price').value = price;
        document.getElementById('med-stock').value = stock;
        
        var modal = new bootstrap.Modal(document.getElementById('medicineModal'));
        modal.show();
    }
    
    // Reset Modal khi ƒë√≥ng
    document.getElementById('medicineModal').addEventListener('hidden.bs.modal', function (event) {
        document.getElementById('medicineModalLabel').innerText = 'Th√™m Thu·ªëc M·ªõi';
        document.getElementById('medicine-form').reset();
        document.getElementById('med-id').value = '';
    });
    
    // === LOGIC CHATBOT ===
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtnChat = document.getElementById('send-btn'); 
    const chatbotBox = document.getElementById('chatbot-box');

    function addMessage(text, sender, isError = false) {
        let box = document.getElementById("chat-messages");
        let div = document.createElement("div");
        div.className = sender === "user" ? "msg-user" : "msg-bot";
        if (isError) {
            div.style.backgroundColor = '#f8d7da'; div.style.color = '#721c24';
        }
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendChat() {
        let input = document.getElementById("chat-input");
        let msg = input.value.trim();
        if (!msg) return;

        addMessage(msg, "user");
        input.value = "";
        
        // Hi·ªán t·∫°i d√πng fetch ƒë∆°n gi·∫£n:
        fetch("/chatbot", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message: msg})
        })
        .then(res => {
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res.json();
        })
        .then(data => {
            addMessage(data.reply, "bot");
        })
        .catch(error => {
            console.error("Chatbot Error:", error);
            addMessage("L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω Bot.", "bot", true);
        });
    }

    /* Hi·ªán/·∫©n chatbot */
    document.getElementById("chatbot-btn").onclick = () => {
        chatbotBox.style.display = (chatbotBox.style.display === "flex") ? "none" : "flex";
    };

    /* G·ª≠i tin nh·∫Øn chatbot */
    document.getElementById("send-btn").onclick = sendChat;
    document.getElementById("chat-input").addEventListener("keypress", e => {
        if (e.key === "Enter") sendChat();
    });
    
    // === LOGIC SEARCH (ƒê√£ c·∫≠p nh·∫≠t) ===
    document.getElementById("patient-search").oninput = function () {
      let f = this.value.toLowerCase();
      document.querySelectorAll("#patient-table tbody tr").forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(f) ? "" : "none";
      });
    };

    document.getElementById("appointment-search").oninput = function () {
      let f = this.value.toLowerCase();
      document.querySelectorAll("#appointment-table tbody tr").forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(f) ? "" : "none";
      });
    };
    
    // ƒê√É TH√äM LOGIC T√åM KI·∫æM CHO ƒê∆†N H√ÄNG
    document.getElementById("order-search").oninput = function () {
      let f = this.value.toLowerCase();
      document.querySelectorAll("#order-table tbody tr").forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(f) ? "" : "none";
      });
    };
</script>

</body>
</html>