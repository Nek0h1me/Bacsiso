<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard | Hospital Portal</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
        body {
            background: #f4f7f6;
            font-family: 'Poppins', sans-serif;
        }

        .navbar {
            background-color: #2a9df4 !important;
        }

        .navbar-brand, .nav-link {
            color: white !important;
        }

        .booking-table {
            background: #ffffff;
            border: 1px solid #cde6ff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .booking-table label {
            font-weight: bold;
            color: #1a4b7a;
        }

        .table th {
            background-color: #2a9df4;
            color: white;
            text-align: center;
        }

        .table td {
            vertical-align: middle;
        }

        #preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            display: none;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        /* === CSS CHATBOT N·ªîI (Floating Chatbot) === */
        #chatbot-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: #2a9df4; /* ƒê·ªïi m√†u xanh d∆∞∆°ng cho h·ª£p theme user */
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
            z-index: 9999;
        }

        #chatbot-box {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 350px;
            height: 450px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 9999;
        }

        #chat-header {
            background: #2a9df4; /* M√†u header */
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 18px;
        }

        #chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        /* Bong b√≥ng chat ng∆∞·ªùi d√πng */
        .msg-user {
            background: #b3e0ff; /* M√†u xanh nh·∫°t */
            color: #333;
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            width: fit-content;
            max-width: 80%;
            margin-left: auto;
        }

        /* Bong b√≥ng chat Bot */
        .msg-bot {
            background: #f0f0f0; 
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            width: fit-content;
            max-width: 80%;
        }

        #chat-input-box {
            display: flex;
            border-top: 1px solid #ddd;
        }

        #chat-input {
            flex: 1;
            border: none;
            padding: 10px;
            outline: none;
        }

        #send-btn-chat {
            background: #2a9df4;
            color: white;
            border: none;
            padding: 10px 15px;
        }
        
        /* Hi·ªáu ·ª©ng loading */
        .loading-dot {
            height: 10px;
            width: 10px;
            background-color: #ccc;
            border-radius: 50%;
            display: inline-block;
            margin-left: 4px;
            animation: dot-blink 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dot-blink {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* ------------------- CSS cho Autocomplete ------------------- */
        .medicine-search-container {
            position: relative;
        }

        #medicine-results {
            position: absolute;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            z-index: 10;
            border-radius: 5px;
            margin-top: 5px;
        }

        .medicine-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .medicine-result-item:hover {
            background-color: #f0f8ff;
        }
        .item-name {
            font-weight: bold;
            color: #2a9df4;
        }
        .item-info {
            font-size: 0.85em;
            color: #6c757d;
        }
        /* ----------------------------------------------------------- */
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">üè• B√°c Sƒ© S·ªë</a>
            <div class="ms-auto">
                <a href="{{ url_for('logout') }}" class="btn btn-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- ======================= KHU V·ª∞C CH√çNH (2 C·ªòT) ======================= -->
        <div class="row">
            
            <!-- C·ªòT TR√ÅI: ƒê·∫∑t l·ªãch v√† Mua Thu·ªëc -->
            <div class="col-lg-6">
                
                <!-- Khu v·ª±c ƒê·∫∂T L·ªäCH -->
                <h3 class="text-primary mb-3">ƒê·∫∑t L·ªãch Kh√°m</h3>
                <form method="POST" action="{{ url_for('book') }}" enctype="multipart/form-data" class="booking-table mb-4">
                    <div class="mb-3">
                        <label>Lo·∫°i b·ªánh / Tri·ªáu ch·ª©ng</label>
                        <input type="text" name="disease" class="form-control" placeholder="VD: ƒêau ƒë·∫ßu, kh√≥ th·ªü..." required>
                    </div>

                    <div class="mb-3">
                        <label>Ng√†y kh√°m</label>
                        <input type="date" name="date" id="date-input" class="form-control"
                               min="{{ today_date }}" required>
                    </div>

                    <div class="mb-3">
                        <label>Gi·ªù kh√°m</label>
                        <input type="time" name="time" id="time-input" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label>·∫¢nh / File kh√°m b·ªánh</label>
                        <input type="file" name="image" id="image-upload" class="form-control" accept="image/*">
                        <img id="preview" src="#" alt="Image Preview">
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-success px-4">ƒê·∫∑t L·ªãch</button>
                    </div>

                </form>
                
                <!-- Khu v·ª±c MUA THU·ªêC (ƒê√É CHUY·ªÇN SANG SEARCH) -->
                <h3 class="text-primary mt-5 mb-3">Mua Thu·ªëc Tr·ª±c Tuy·∫øn</h3>
                <div class="booking-table">
                    
                    <div class="medicine-search-container mb-4">
                        <label for="medicine-search">T√¨m ki·∫øm T√™n Thu·ªëc</label>
                        <input type="text" id="medicine-search" class="form-control" placeholder="G√µ t√™n thu·ªëc b·∫°n c·∫ßn mua...">
                        <div id="medicine-results">
                            <!-- K·∫øt qu·∫£ t√¨m ki·∫øm s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y -->
                        </div>
                    </div>
                    
                    <!-- Form Mua Thu·ªëc ch√≠nh (·∫©n/hi·ªán khi ch·ªçn thu·ªëc) -->
                    <form method="POST" action="{{ url_for('order_medicine') }}" id="order-form" class="mt-3 p-3 border rounded" style="display: none;">
                        <input type="hidden" name="medicine_id" id="form-med-id">
                        
                        <h5 class="text-success" id="selected-med-name"></h5>
                        <p class="text-muted" id="selected-med-description"></p>
                        
                        <div class="row align-items-end">
                            <div class="col-md-5 mb-3">
                                <label for="form-quantity">S·ªë l∆∞·ª£ng (T·ªìn kho: <span id="form-stock">0</span>)</label>
                                <input type="number" name="quantity" id="form-quantity" class="form-control" min="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <span class="badge bg-info text-dark p-2" id="form-price"></span>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button type="submit" class="btn btn-primary w-100">Mua ngay</button>
                            </div>
                        </div>
                        
                    </form>
                    
                </div>
                
            </div>
            
            <!-- C·ªòT PH·∫¢I: L·ªãch s·ª≠ -->
            <div class="col-lg-6">
                
                <!-- L·ªãch s·ª≠ L·ªäCH KH√ÅM -->
                <h3 class="text-primary mb-3">L·ªãch Kh√°m C·ªßa B·∫°n</h3>
                <table class="table table-bordered table-striped mb-5">
                    <thead>
                        <tr>
                            <th>B·ªánh</th>
                            <th>Ng√†y & Gi·ªù</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>·∫¢nh</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in appointments %}
                        <tr>
                            <td>{{ a[0] }}</td>
                            <td>{{ a[1] }}</td>

                            <td class="text-center">
                                {% if a[2] == 'approved' %}
                                  <span class="badge bg-success">Ch·∫•p nh·∫≠n</span>
                                {% elif a[2] == 'rejected' %}
                                  <span class="badge bg-danger">T·ª´ ch·ªëi</span>
                                {% else %}
                                  <span class="badge bg-secondary">ƒêang ch·ªù</span>
                                {% endif %}
                            </td>

                            <td class="text-center">
                                {% if a[3] %}
                                  <a href="{{ url_for('uploaded_file', filename=a[3]) }}" target="_blank" class="btn btn-sm btn-primary">
                                    Xem
                                  </a>
                                {% else %}
                                  ‚Äî
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- L·ªãch s·ª≠ ƒê∆†N H√ÄNG -->
                <h3 class="text-primary mb-3">L·ªãch S·ª≠ ƒê∆°n H√†ng</h3>
                <table class="table table-bordered table-striped mb-5">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Thu·ªëc</th>
                            <th>SL</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for o in orders %}
                        <tr>
                            <td>#{{ o[0] }}</td>
                            <td>{{ o[1] }}</td>
                            <td>{{ o[2] }}</td>
                            <td>{{ "{:,.0f}".format(o[3]) }} VNƒê</td>
                            <td class="text-center">
                                {% if o[5] == 'processed' %}
                                  <span class="badge bg-success">ƒê√£ x·ª≠ l√Ω</span>
                                {% elif o[5] == 'cancelled' %}
                                  <span class="badge bg-danger">ƒê√£ h·ªßy</span>
                                {% else %}
                                  <span class="badge bg-warning text-dark">ƒêang ch·ªù</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
            </div>
            
        </div>
    </div>
    
    <!-- CHATBOT BUTTON (N·ªîI) -->
    <button id="chatbot-btn">üí¨</button>

    <!-- CHATBOT BOX (N·ªîI) -->
    <div id="chatbot-box">
        <div id="chat-header">ü§ñ ChatBot - Tr·ª£ L√Ω S·ª©c Kh·ªèe</div>
        <div id="chat-messages"></div>

        <div id="chat-input-box">
            <input id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
            <button id="send-btn-chat">G·ª≠i</button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript gi·ªõi h·∫°n gi·ªù + preview ·∫£nh + CHATBOT LOGIC -->
    <script>
        // L·∫•y d·ªØ li·ªáu thu·ªëc t·ª´ Flask (Jinja2) v√† l∆∞u v√†o bi·∫øn JavaScript
        const ALL_MEDICINES = JSON.parse('{{ medicines | tojson | safe }}');
        
        // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
        });
        
        // === LOGIC MUA THU·ªêC (AUTOSUGGEST) ===
        const searchInput = document.getElementById('medicine-search');
        const resultsDiv = document.getElementById('medicine-results');
        const orderForm = document.getElementById('order-form');
        const formMedId = document.getElementById('form-med-id');
        const formQuantity = document.getElementById('form-quantity');
        const selectedMedName = document.getElementById('selected-med-name');
        const selectedMedDescription = document.getElementById('selected-med-description');
        const formStock = document.getElementById('form-stock');
        const formPrice = document.getElementById('form-price');

        // H√†m l·ªçc v√† hi·ªÉn th·ªã k·∫øt qu·∫£
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            resultsDiv.innerHTML = '';
            
            if (query.length === 0) {
                orderForm.style.display = 'none';
                return;
            }

            const filtered = ALL_MEDICINES.filter(med => 
                // m[1] l√† name, m[2] l√† description
                med[1].toLowerCase().includes(query) || med[2].toLowerCase().includes(query)
            );

            if (filtered.length > 0) {
                filtered.forEach(med => {
                    const [id, name, description, price, stock] = med;
                    
                    const item = document.createElement('div');
                    item.classList.add('medicine-result-item');
                    item.innerHTML = `
                        <div class="item-name">${name}</div>
                        <div class="item-info">${description} - Gi√°: ${formatter.format(price)} (${stock} ƒë∆°n v·ªã)</div>
                    `;
                    
                    // G√°n s·ª± ki·ªán click ƒë·ªÉ ch·ªçn thu·ªëc
                    item.addEventListener('click', () => selectMedicine(med));
                    resultsDiv.appendChild(item);
                });
            } else {
                resultsDiv.innerHTML = '<div class="p-3 text-muted">Kh√¥ng t√¨m th·∫•y thu·ªëc n√†o.</div>';
            }
        });
        
        // H√†m ch·ªçn thu·ªëc
        function selectMedicine(med) {
            const [id, name, description, price, stock] = med;
            
            // 1. C·∫≠p nh·∫≠t form
            formMedId.value = id;
            selectedMedName.innerText = name;
            selectedMedDescription.innerText = description;
            formStock.innerText = stock;
            formPrice.innerText = formatter.format(price);
            
            // 2. Thi·∫øt l·∫≠p gi·ªõi h·∫°n cho input s·ªë l∆∞·ª£ng
            formQuantity.max = stock;
            formQuantity.value = 1;
            formQuantity.min = 1;
            
            // 3. ·∫®n k·∫øt qu·∫£ t√¨m ki·∫øm v√† hi·ªÉn th·ªã form mua
            resultsDiv.innerHTML = '';
            searchInput.value = name;
            orderForm.style.display = 'block';
            
            // 4. N·∫øu t·ªìn kho = 0 th√¨ v√¥ hi·ªáu h√≥a n√∫t mua
            if (stock === 0) {
                formQuantity.disabled = true;
                orderForm.querySelector('button[type="submit"]').disabled = true;
                formPrice.innerText = "H·∫øt h√†ng";
            } else {
                formQuantity.disabled = false;
                orderForm.querySelector('button[type="submit"]').disabled = false;
            }
        }
        
        // ·∫®n k·∫øt qu·∫£ khi click ra ngo√†i
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.medicine-search-container') && event.target !== searchInput) {
                // Ch·ªâ x√≥a k·∫øt qu·∫£ t√¨m ki·∫øm n·∫øu √¥ input r·ªóng ho·∫∑c ƒë√£ ch·ªçn thu·ªëc
                if (searchInput.value === '' || formMedId.value) {
                    resultsDiv.innerHTML = '';
                }
            }
        });


        // === LOGIC ƒê·∫∂T L·ªäCH & PREVIEW 
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('date-input');
            const timeInput = document.getElementById('time-input');

            const today_date = "{{ today_date }}";
            const current_time = "{{ current_time }}";

            // Logic gi·ªõi h·∫°n th·ªùi gian (kh√¥ng cho ch·ªçn qu√° kh·ª©)
            function updateMinTime() {
                if (dateInput.value === today_date) timeInput.min = current_time;
                else timeInput.min = null;
            }

            dateInput.addEventListener('change', updateMinTime);
            updateMinTime();

            // Logic Preview ·∫¢nh
            const imageUpload = document.getElementById('image-upload');
            const previewImg = document.getElementById('preview');

            imageUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImg.style.display = 'none';
                }
            });
            
            // Kh·ªüi t·∫°o tin nh·∫Øn ch√†o m·ª´ng
            addMessage("Ch√†o b·∫°n! T√¥i l√† tr·ª£ l√Ω s·ª©c kh·ªèe AI. H√£y h·ªèi t√¥i v·ªÅ c√°c v·∫•n ƒë·ªÅ s·ª©c kh·ªèe th∆∞·ªùng g·∫∑p.", "bot");
        });

        // === LOGIC CHATBOT ===
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtnChat = document.getElementById('send-btn-chat');
        const chatbotBox = document.getElementById('chatbot-box');

        // H√†m hi·ªÉn th·ªã tin nh·∫Øn trong h·ªôp chat (S·ª≠ d·ª•ng CSS bong b√≥ng)
        function addMessage(text, sender, isError = false) {
            const div = document.createElement("div");
            div.className = "msg-" + sender;
            if (isError) {
                div.style.backgroundColor = '#f8d7da'; // M√†u l·ªói
                div.style.color = '#721c24';
            }
            div.innerText = text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return div; // Tr·∫£ v·ªÅ element ƒë·ªÉ c·∫≠p nh·∫≠t loading
        }
        
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang g√µ
        function showLoading() {
            const loadingHtml = `<div class="msg-bot" id="loading-dots">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            </div>`;
            chatMessages.insertAdjacentHTML('beforeend', loadingHtml);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideLoading() {
            const loadingElement = document.getElementById('loading-dots');
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        // H√†m g·ª≠i tin nh·∫Øn t·ªõi Flask Backend
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message === "") return;

            // 1. Kh√≥a input v√† n√∫t g·ª≠i
            chatInput.disabled = true;
            sendBtnChat.disabled = true;

            // 2. Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
            addMessage(message, "user");
            chatInput.value = ''; 
            
            // 3. Hi·ªÉn th·ªã loading
            showLoading();

            // 4. G·ªçi API Flask (/chatbot)
            fetch('/chatbot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'message': message })
            })
            .then(response => {
                // ·∫®n loading ngay khi nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi HTTP
                hideLoading(); 
                
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status}. M√£ l·ªói: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // 5. Hi·ªÉn th·ªã ph·∫£n h·ªìi t·ª´ Bot
                const reply = data.reply || "Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y.";
                addMessage(reply, "bot");
            })
            .catch(error => {
                // 6. X·ª≠ l√Ω l·ªói k·∫øt n·ªëi
                hideLoading();
                console.error("L·ªói Chatbot:", error);
                addMessage(`L·ªói h·ªá th·ªëng: ${error.message}. Vui l√≤ng ki·ªÉm tra console Flask.`, "bot", true);
            })
            .finally(() => {
                // M·ªü l·∫°i input v√† n√∫t g·ª≠i
                chatInput.disabled = false;
                sendBtnChat.disabled = false;
                chatInput.focus();
            });
        }
        
        // === CONTROLLERS ===

        /* Hi·ªán/·∫©n chatbot */
        document.getElementById("chatbot-btn").onclick = () => {
             chatbotBox.style.display = (chatbotBox.style.display === "flex") ? "none" : "flex";
        };

        /* G·ª≠i tin nh·∫Øn chatbot */
        sendBtnChat.onclick = sendMessage;
        chatInput.addEventListener("keydown", e => {
            if (e.key === "Enter") sendMessage();
        });
        
    </script>

</body>
</html>